<!DOCTYPE html>
<html>

<head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>龙鑫商城</title>

    <link th:href="@{css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{css/fileinput.css}"rel="stylesheet" type="text/css" />
    <link th:href="@{font-awesome/css/font-awesome.css}" rel="stylesheet">
	<link th:href="@{css/themes/explorer-fa/theme.min.css}"rel="stylesheet" type="text/css" />
    <link th:href="@{css/plugins/dataTables/datatables.min.css}" rel="stylesheet">
	<link th:href="@{css/plugins/dropzone/basic.css}" rel="stylesheet">
    <link th:href="@{css/plugins/dropzone/dropzone.css}" rel="stylesheet">
    <link th:href="@{css/animate.css}" rel="stylesheet">
    <link th:href="@{css/style.css}" rel="stylesheet">
</head>

<body>

    <div id="wrapper">

    <nav class="navbar-default navbar-static-side" role="navigation">
        <div class="sidebar-collapse">
            <ul class="nav metismenu" id="side-menu">
                <li class="nav-header">
                    <div class="dropdown profile-element"> <span>
                            <img alt="image" class="img-circle" src="img/profile_small.jpg" />
                             </span>
                        <a data-toggle="dropdown" class="dropdown-toggle" href="table_data_tables.html#">
                            <span class="clear"> <span class="block m-t-xs"> <strong class="font-bold">David Williams</strong>
                             </span> <!-- <span class="text-muted text-xs block">Art Director <b class="caret"></b></span> </span> --> </a>
<!--                         <ul class="dropdown-menu animated fadeInRight m-t-xs"> -->
<!--                             <li><a href="profile.html">Profile</a></li> -->
<!--                             <li><a href="contacts.html">Contacts</a></li> -->
<!--                             <li><a href="mailbox.html">Mailbox</a></li> -->
<!--                             <li class="divider"></li> -->
<!--                             <li><a href="login.html">Logout</a></li> -->
<!--                         </ul> -->
                    </div>
                    <div class="logo-element">
                        IN+
                    </div>
                </li>
                <li>
                    <a th:href="@{menu}"><i class="fa fa-th-large"></i> <span class="nav-label">商品管理</span> <span class="fa arrow"></span></a>
                    <ul class="nav nav-second-level collapse">
                        <li><a th:href="@{menu}"> 菜单管理</a></li>
                        <li><a th:href="@{goods}">商品管理</a></li>
                    </ul>
                </li>
                <li class="active">
                    <a th:href="@{order}"><i class="fa fa-th-large"></i> <span class="nav-label">订单管理</span> <span class="fa arrow"></span></a>
                    <ul class="nav nav-second-level collapse">
                        <li class="active"><a th:href="@{order}"> 订单管理</a></li>
                    </ul>
                </li>
            </ul>

        </div>
    </nav>

        <div id="page-wrapper" class="gray-bg">
        <div class="row border-bottom">
        <nav class="navbar navbar-static-top" role="navigation" style="margin-bottom: 0">
            <ul class="nav navbar-top-links navbar-right">
                <li>
                    <span class="m-r-sm text-muted welcome-message">Welcome to INSPINIA+ Admin Theme.</span>
                </li>
                <li class="dropdown">
                    <a class="dropdown-toggle count-info" data-toggle="dropdown" href="table_data_tables.html#">
                        <i class="fa fa-bell"></i>  <span class="label label-primary">8</span>
                    </a>
                    <ul class="dropdown-menu dropdown-alerts">
                        <li>
                            <a href="mailbox.html">
                                <div>
                                    <i class="fa fa-envelope fa-fw"></i> You have 16 messages
                                    <span class="pull-right text-muted small">4 minutes ago</span>
                                </div>
                            </a>
                        </li>
                        <li class="divider"></li>
                        <li>
                            <a href="profile.html">
                                <div>
                                    <i class="fa fa-twitter fa-fw"></i> 3 New Followers
                                    <span class="pull-right text-muted small">12 minutes ago</span>
                                </div>
                            </a>
                        </li>
                        
                    </ul>
                </li>


                <li>
                    <a href="login.html">
                        <i class="fa fa-sign-out"></i> Log out
                    </a>
                </li>
            </ul>

        </nav>
        </div>
        
        <div class="modal fade" id="orderModal" tabindex="-1" role="dialog" data-backdrop="static" aria-labelledby="myModalLabel" aria-hidden="true">
		    <div class="modal-dialog">
		        <div class="modal-content">
		            <div class="modal-header">
		                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
		                <h4 class="modal-title" id="myModalLabel">订单详情</h4>
		            </div>
		            <form id="orderForm">
		            	<div class="modal-body">
		            		<div class="row">
			            		<div class="form-group">
				            		<label class="control-label">商品名称：</label>
				            		<input type="text" name="title" id="title" readonly class="form-control" />
			            		</div>
			            	</div>
			            	<div class="row">
			            		<div class="form-group">
				            		<label class="control-label">交易流水号：</label>
				            		<input type="text" name="traceNo" id="traceNo" readonly class="form-control" />
			            		</div>
			            	</div>
			            	<div class="row">
			            		<div class="form-group">
				            		<label class="control-label">周边通订单号：</label>
				            		<input type="text" name="backTraceNo" id="backTraceNo" readonly class="form-control" />
			            		</div>
			            	</div>
			            	<div class="row">
			            		<div class="form-group">
				            		<label class="control-label">订单号：</label>
				            		<input type="text" name="id" id="id" readonly class="form-control" />
			            		</div>
			            	</div>
			            	<div class="row">
			            		<div class="form-group col-sm-5">
			            			<div class="row">
					            		<label class="control-label">订单状态：</label>
					            		<input type="text" name="ordrStatus" id="ordrStatus" readonly class="form-control" />
			            			</div>
			            		</div>
			            		<div class="form-group col-sm-2"></div>
			            		<div class="form-group col-sm-5">
			            			<div class="row">
					            		<label class="control-label">物流状态：</label>
					            		<input type="text" name="deliverStatus" id="deliverStatus" readonly class="form-control" />
			            			</div>
			            		</div>
			            	</div>
			            	<div class="row">
			            		<div class="form-group col-sm-5">
			            			<div class="row">
					            		<label class="control-label">交易总金额：</label>
					            		<input type="text" name="totalOrdrAmt" id="totalOrdrAmt" readonly class="form-control" />
			            			</div>
			            		</div>
			            		<div class="form-group col-sm-2"></div>
			            		<div class="form-group col-sm-5">
			            			<div class="row">
					            		<label class="control-label">优惠金额：</label>
					            		<input type="text" name="discountAmt" id="discountAmt" readonly class="form-control" />
			            			</div>
			            		</div>
			            	</div>
			            	<div class="row">
			            		<div class="form-group col-sm-5">
			            			<div class="row">
					            		<label class="control-label">实付金额：</label>
					            		<input type="text" name="payAmt" id="payAmt" readonly class="form-control" />
			            			</div>
			            		</div>
			            		<div class="form-group col-sm-2"></div>
			            		<div class="form-group col-sm-5">
			            			<div class="row">
					            		<label class="control-label">商品数量：</label>
					            		<input type="text" name="count" id="count" readonly class="form-control" />
			            			</div>
			            		</div>
			            	</div>
			            	<div class="row">
			            		<div class="form-group">
				            		<label class="control-label">收货地址：</label>
				            		<input type="text" name="recvAddr" id="recvAddr" readonly class="form-control" />
			            		</div>
			            	</div>
			            	<div class="row">
			            		<div class="form-group">
				            		<label class="control-label">交易时间：</label>
				            		<input type="text" name="createTime" id="createTime" readonly class="form-control" />
			            		</div>
			            	</div>
		            	</div>
		            </form>
		            <div class="modal-footer">
		                <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
		            </div>
		        </div>
		    </div>
        </div>
        
        <div class="wrapper wrapper-content animated fadeInRight">
            <div class="row">
            <div class="col-lg-12">
            <div class="ibox float-e-margins">
            <div class="ibox-title">
                <h5>菜单管理</h5>
                <div class="ibox-tools">
                    <a class="collapse-link">
                        <i class="fa fa-chevron-up"></i>
                    </a>
	                 <a class="close-link">
                        <i class="fa fa-times"></i>
                    </a>
                </div>
            </div>
            <div class="ibox-content">
	            <div class="">
	            	<a  href="javascript:void(0);" onclick="refund()" class="btn btn-danger ">退款</a>
		            <a  href="javascript:void(0);" data-toggle="modal" data-target="#addMenu" class="btn btn-warning ">修改</a>
		            <a  href="javascript:void(0);" onclick="showOrder()" class="btn btn-primary ">查看详情</a>
	            </div>
            <table class="table table-striped table-bordered table-hover " id="editable" >
            <thead>
            <tr>
                <th style="text-align: center;"><input type="checkbox" onchange="allselect()" class="checkchild" /></th>
                <th >商品名称</th>
                <th >交易流水号</th>
                <th >周边通订单号</th>
                <th >订单号</th>
                <th >交易状态</th>
                <th >交易总金额</th>
                <th >物流状态</th>
            </tr>
            </thead>
            <tbody>
<!--             	<tr th:each="menu:${params.classified}"> -->
<!--             		<td style="display:none" th:text="${menu.id}"></td> -->
<!--             		<td th:text="${menu.menuName}"></td> -->
<!--             		<td th:text="${menu.parentName}"></td> -->
<!--             		<td style="display:none" th:text="${menu.parentId}"></td> -->
<!--             	</tr> -->
            </tbody>
            </table>

            </div>
            </div>
            </div>
            </div>
        </div>
        <div class="footer">
<!--             <div class="pull-right"> -->
<!--                 10GB of <strong>250GB</strong> Free. -->
<!--             </div> -->
            <div>
                <strong>Copyright</strong> 龙鑫出品 &copy; 2018-2019
            </div>
        </div>

        </div>
        </div>



    <!-- Mainly scripts -->
    <script th:src="@{js/jquery-2.1.1.js}"></script>
    <script th:src="@{js/bootstrap.min.js}"></script>
    <script th:src="@{js/plugins/metisMenu/jquery.metisMenu.js}"></script>
    <script th:src="@{js/plugins/slimscroll/jquery.slimscroll.min.js}"></script>
    <script th:src="@{js/plugins/jeditable/jquery.jeditable.js}"></script>

    <script th:src="@{js/plugins/dataTables/datatables.min.js}"></script>

    <!-- Custom and plugin javascript -->
    <script th:src="@{js/inspinia.js}"></script>
    <script th:src="@{js/plugins/pace/pace.min.js}"></script>
<!-- 	<script th:src="@{js/plugins/dropzone/dropzone.js}"></script> -->
    <!-- Page-Level Scripts -->
    <script>
        $(document).ready(function(){
            lang = {
            	    "sProcessing": "处理中...",
            	    "sLengthMenu": "每页 _MENU_ 项",
            	    "sZeroRecords": "没有匹配结果",
            	    "sInfo": "当前显示第 _START_ 至 _END_ 项，共 _TOTAL_ 项。",
            	    "sInfoEmpty": "当前显示第 0 至 0 项，共 0 项",
            	    "sInfoFiltered": "(由 _MAX_ 项结果过滤)",
            	    "sInfoPostFix": "",
            	    "sSearch": "搜索：",
            	    "sUrl": "",
            	    "sEmptyTable": "暂无数据",
            	    "sLoadingRecords": "载入中...",
            	    "sInfoThousands": ",",
            	    "oPaginate": {
            	        "sFirst": "首页",
            	        "sPrevious": "上页",
            	        "sNext": "下页",
            	        "sLast": "末页",
            	        "sJump": "跳转"
            	    },
            	    "oAria": {
            	        "sSortAscending": ": 以升序排列此列",
            	        "sSortDescending": ": 以降序排列此列"
            	    }
            	};
            
            /* Init DataTables */
            var oTable = $('#editable').DataTable({
            	"processing" : false, //DataTables载入数据时，是否显示进度条
            	"oLanguage":lang,
            	"order":[],
            	cache: false,
            	sortable: true,
            	hover:true,
            	serverSide: true,  //启用服务器端分页
            	renderer: "bootstrap",  //渲染样式：Bootstrap和jquery-ui
            	pagingType: "simple_numbers",  //分页样式：simple,simple_numbers,full,full_numbers
            	dom: '<"html5buttons"B>lTfgitp',
                buttons: [
                    {extend: 'excel',title: 'ExampleFile'},
                    {extend: 'pdf',title: 'ExampleFile'},
                    {extend: 'print',
                     customize: function (win){
                            $(win.document.body).addClass('white-bg');
                            $(win.document.body).css('font-size', '10px');

                            $(win.document.body).find('table')
                                    .addClass('compact')
                                    .css('font-size', 'inherit');
                    }
                    }
                ],
            	stripeClasses: ["odd", "even"],  //为奇偶行加上样式，兼容不支持CSS伪类的场合
            	"ajax": function (data, callback, settings){  // ajax 请求数据
            		//封装请求参数
            		 var param = {};
            		 param.length = data.length;//页面显示记录条数，在页面显示每页显示多少项的时候
            		 param.start = data.start/data.length;//开始的记录序号
            		 param.draw = data.draw;//当前页码
					 param.search = data.search.value;
					 if(data.order.length > 0){
	            		 param.orderColumn = data.order[0].column;
						 param.orderSort = data.order[0].dir;
					 }
            		 //ajax请求数据
            		 $.ajax({
            		     type: "POST",
            		     url: "loadOrders",
            		     cache: false,  //禁用缓存
            		     data: JSON.stringify(param),
            		     contentType:"application/json",
            		     dataType: "json",
            		     success: function (result) {
            		         //封装返回数据
            		         var returnData = {};
            		         returnData.draw = result.draw;//这里直接自行返回了draw计数器,应该由后台返回
            		         returnData.recordsTotal = result.recordsTotal;//返回数据全部记录
            		         returnData.recordsFiltered = result.recordsFiltered;//后台不实现过滤功能，每次查询均视作全部结果
            		         returnData.data = result.data;//返回的数据列表
            		         //调用DataTables提供的callback方法，代表数据已封装完成并传回DataTables进行渲染
            		         //此时的数据需确保正确无误，异常判断应在执行此回调前自行处理完毕
             		         callback(returnData);
            		     },
            		     error: function(msg){
            		    	 console.log(msg);
            		     }
            		 });
            	 },
            	 "columns":[
            		 {
            		 	 "data":"id",
            			 "orderable": false,
            			 "createdCell": function (td, cellData, rowData, row, col) {  
		                      $(td).css('text-align', 'center'); 
		                 },
           				 render(data, type, full, meta) { 
            				 	return '<input type="checkbox" class="checkchild" onclick="checktr()" value="${data}" />';
                         }
            		 },
            		 {
            		 	"data":"goods.title",
            		 	"orderable": true,
            		 	"searchable": true
            		 },
            		 {
            		 	"data":"trans.traceNo",
            		 	"orderable": true
            		 },
            		 {
            		 	"data":"trans.backChnlTraceNo",
            		 	"orderable": true
            		 },
            		 {
            		 	"data":"id",
            		 	"orderable": true
            		 },
            		 {
            		 	"data":"orderStatus",
            		 	"orderable": true,
            		 	render(data, type, full, meta) { 
            		 		var orderStatus = "";
				    		if(full.orderStatus == '00'){
				    			orderStatus = '成功';
				    		}else if(full.orderStatus == '01'){
				    			orderStatus = '失败';
				    		}else if(full.orderStatus == '03'){
				    			orderStatus = '待支付';
				    		}else if(full.orderStatus == '04'){
				    			orderStatus = '取消';
				    		}else if(full.orderStatus == '05'){
				    			orderStatus = '未支付';
				    		}else if(full.orderStatus == '06'){
				    			orderStatus = '退款中';
				    		}else if(full.orderStatus == '07'){
				    			orderStatus = '已退款';
				    		}
				    		return orderStatus;
            		 	}
            		 },
            		 {
            		 	"data":"totalOrdrAmt",
            		 },
            		 {
            		 	"data":"deliverStatus",
            		 	"orderable": true,
            		 	render(data, type, full, meta) {
            		 		var deliverStatus = '';
				    		if(data.deliverStatus == "01"){
				    			deliverStatus = '待发货';
				    		}else if(data.deliverStatus == "02"){
				    			deliverStatus = '待收货';
				    		}else{
				    			deliverStatus = '已收货';
				    		}
				    		return deliverStatus;
            		 	}
            		 },
            		 {
            		 	"data":"",
            		 	"visible":false,
            		 	render(data, type, full, meta) {
            		 		return full;
            		 	}
            		 }
            	 ]
            	
            });
            
            $('#editable tbody').on('click', 'tr', function selectrow(event,s) {
	           		if(s){
	           		   $(this).addClass('selected');
				       $(this).find(".checkchild").prop("checked",true);
	           		}else if(s == false){
	           			$(this).removeClass('selected');
				      	$(this).find(".checkchild").prop("checked",false);
	           		}else{
					    if ($(this).hasClass('selected')) {
					       $(this).removeClass('selected');
					       $(this).find(".checkchild").prop("checked",false);
					    } else {
					       $(this).addClass('selected');
					       $(this).find(".checkchild").prop("checked",true);
					    }
					}
			});
			
			
	            
        });
        
        $('#editable tbody').on('dblclick','tr',function showDetail(e){
       	 	var data = $('#editable').dataTable().fnGetData($(this).context.rowIndex);
        	showDetails(data);
        });

		function showOrder(){
		   var rows =  $('#editable').DataTable().rows('.selected').data();
     	   if(rows.length != 1){
     	  		alert("有且仅选择一条数据查看详情");
     	  		return;
     	   }
     	   showDetails(rows[0]);
		}

		function showDetails(data){
    		$('#title').val(data.goods.title);
    		$('#traceNo').val(data.trans.traceNo);
    		$('#backTraceNo').val(data.trans.backChnlTraceNo);
    		$('#id').val(data.id);
    		var orderStatus = "";
    		if(data.orderStatus == '00'){
    			orderStatus = '成功';
    		}else if(data.orderStatus == '01'){
    			orderStatus = '失败';
    		}else if(data.orderStatus == '03'){
    			orderStatus = '待支付';
    		}else if(data.orderStatus == '04'){
    			orderStatus = '取消';
    		}else if(data.orderStatus == '05'){
    			orderStatus = '未支付';
    		}else if(data.orderStatus == '06'){
    			orderStatus = '退款中';
    		}else if(data.orderStatus == '07'){
    			orderStatus = '已退款';
    		}
    		$('#ordrStatus').val(orderStatus);
    		var deliverStatus = '';
    		if(data.deliverStatus == "01"){
    			deliverStatus = '待发货';
    		}else if(data.deliverStatus == "02"){
    			deliverStatus = '待收货';
    		}else{
    			deliverStatus = '已收货';
    		}
    		$('#deliverStatus').val(deliverStatus);
    		$('#totalOrdrAmt').val(data.totalOrdrAmt);
    		$('#discountAmt').val(data.discountAmt);
    		$('#payAmt').val(data.payAmt);
    		$('#recvAddr').val(data.address.provice+data.address.city+data.address.county+data.address.detailedAddr);
    		$('#count').val(data.count);
    		$('#createTime').val(data.createTime.substring(0,data.createTime.lastIndexOf('+')));
			$('#orderModal').modal('show');
		}

        $('#orderModal').on('hide.bs.modal', function () {
        	$('#title').val('');
    		$('#traceNo').val('');
    		$('#backTraceNo').val('');
    		$('#id').val('');
    		$('#ordrStatus').val('');
    		$('#deliverStatus').val('');
    		$('#totalOrdrAmt').val('');
    		$('#discountAmt').val('');
    		$('#payAmt').val('');
    		$('#recvAddr').val('');
    		$('#count').val('');
    		$('#createTime').val('');
        });
        
        
        function refund(){
        	var rows =  $('#editable').DataTable().rows('.selected').data();
     	   if(rows.length != 1){
     	  		alert("有且仅选择一条数据发起退款");
     	  		return;
     	   }
     	   if(rows[0].orderStatus!='00'){
     	   		alert("订单状态非成功，不可以发起退款");
     	  		return;
     	   }
        	var param = {'id': rows[0].id};
        	$.ajax({
  		     type: "POST",
  		     url: "refund",
  		     data:JSON.stringify(param),
  		     cache: false,  //禁用缓存
  		     data: JSON.stringify(param),
  		   	 contentType:"application/json",
  		     success: function (result) {
  		     	if(result.respcode!='000000'){
  		     		alert('订单：'+rows[0].id+'退款失败|'+result.respmsg);
  		     	}
  		     },
  		     error:function (msg){
  		     	alert('订单：'+rows[0].id+'退款失败');
  		     	console.log(msg);
  		     }
  		    });
        }
        
         function checktr(){
	       		var row = $(this).closest("tr");
	       		if(row.hasClass('selected')){
	       			row.removeClass('selected');
	       		}else{
	       			row.addClass('selected');
	       		}
	       }
	       //全选行
	       function allselect(){
	       		$('#editable tbody').find("tr").trigger("click",$('#editable thead tr .checkchild')[0].checked);
	       }
       
    </script>

</body>

</html>
